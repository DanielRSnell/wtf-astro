---
// Vanilla JS Comments Component
export interface Props {
  resourceType: string;
  resourceSlug: string;
  className?: string;
}

const { resourceType, resourceSlug, className = '' } = Astro.props;

// Pass Supabase config to client if available
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<div 
  id="comments-container" 
  class={className}
  data-resource-type={resourceType}
  data-resource-slug={resourceSlug}
>
  <!-- Comments will be loaded here by vanilla JS -->
  <div class="text-center py-12">
    <div class="animate-pulse space-y-4">
      <div class="flex gap-3">
        <div class="w-8 h-8 bg-muted rounded-full"></div>
        <div class="flex-1 space-y-2">
          <div class="h-4 bg-muted rounded w-1/4"></div>
          <div class="h-3 bg-muted rounded w-3/4"></div>
        </div>
      </div>
      <div class="flex gap-3">
        <div class="w-8 h-8 bg-muted rounded-full"></div>
        <div class="flex-1 space-y-2">
          <div class="h-4 bg-muted rounded w-1/4"></div>
          <div class="h-3 bg-muted rounded w-3/4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass Supabase config to client for realtime updates -->
{supabaseUrl && supabaseAnonKey && (
  <script define:vars={{ supabaseUrl, supabaseAnonKey }}>
    if (!window.SUPABASE_URL) {
      window.SUPABASE_URL = supabaseUrl;
      window.SUPABASE_ANON_KEY = supabaseAnonKey;
    }
  </script>
)}

<!-- Initialize Comments System -->
<script>
  // Import comments manager
  import '/src/utils/client/comments.js';
  
  // Initialize Supabase client if config is available
  if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY && !window.supabase) {
    import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2').then(({ createClient }) => {
      window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    });
  }
  
  // Initialize comments when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('comments-container');
    
    if (container && window.commentsManager) {
      const resourceType = container.dataset.resourceType;
      const resourceSlug = container.dataset.resourceSlug;
      
      // Initialize comments manager for this container
      window.commentsManager.initialize('comments-container', resourceType, resourceSlug);
    }
  });
</script>